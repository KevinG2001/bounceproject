name: Deploy Backend and Frontend to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # Backend Build and Artifact Creation
      - name: Build Backend
        run: |
          # Navigate to backend directory
          cd backend
          # Install dependencies and build (modify these commands as per your setup)
          npm install
          npm run build
          # Zip backend files as an artifact
          zip -r backend-artifact.zip .

      # Frontend Build and Artifact Creation
      - name: Build Frontend
        run: |
          # Navigate to frontend directory
          cd frontend
          # Install dependencies and build (modify these commands as per your setup)
          npm install
          npm run build
          # Zip frontend files as an artifact
          zip -r frontend-artifact.zip .

      # Upload Backend Artifact
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v2
        with:
          name: backend-app
          path: backend/backend-artifact.zip

      # Upload Frontend Artifact
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v2
        with:
          name: frontend-app
          path: frontend/frontend-artifact.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      # Download Backend Artifact
      - name: Download Backend Artifact
        uses: actions/download-artifact@v2
        with:
          name: backend-app

      # Download Frontend Artifact
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v2
        with:
          name: frontend-app

      # Unzip Backend Artifact
      - name: Unzip Backend Artifact
        run: unzip backend-artifact.zip -d backend-directory

      # Unzip Frontend Artifact
      - name: Unzip Frontend Artifact
        run: unzip frontend-artifact.zip -d frontend-directory
      
      # Install Backend Dependencies
      - name: Install Backend Dependencies
        working-directory: backend-directory
        run: npm install

      # Start Backend
      - name: Start Backend
        working-directory: backend-directory
        run: npm start

      # Serve Frontend (within Backend, adjust as per your setup)
      - name: Serve Frontend (within Backend)
        working-directory: backend-directory
        run: |
          # Assuming your backend serves the frontend
          # Configure your backend to serve frontend files

      # ... (other deployment steps specific to your setup)
